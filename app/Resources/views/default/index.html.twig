{% form_theme form 'bootstrap_3_layout.html.twig' %}
{% extends 'base.html.twig' %}
{% block body %}
    <div id="wrapper">
        <div id="container">
            <div id="welcome">
                <h1><span>Newsletter participative<br>de Nuit Debout <sup>beta</sup></span></h1>
            </div>
            <div id="next">
            <p class="bg-info">
                Cet outil est en cours de développement.<br>
                Suggestions, impressions, bugs : <a href="https://pad.bombastus.duckdns.org/OwMwTAzARiDGAMBaMsCcAORAWMBTJU8YIi6u5AjPFLAGwUxA" target="_blank">écrivez sur ce document</a>
                </p>
            </div>

            <div id="next">
                <h2>Proposez vos articles</h2>
                <div id="cadre">
                    <div class="obligatoire btn-ajout">(*) = champ obligatoire</div>
                    <form id="formProposition" class="form-group" action="#" method="post" name="proposition" {{ form_enctype(form) }}>
                        
                        {{ form_errors(form) }}
                        {{ form_row (form._token) }}

                       <div class="container-fluid">
                            <div class="row">
                              <div class="col-md-4">{{ form_row(form.typeProposition) }}</div>
                              <div class="col-md-4">{{ form_row(form.lieu) }}</div>
                              <div class="col-md-4">{{ form_row(form.theme) }}</div>
                            </div>
                        </div>

                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-md-12">{{ form_row(form.title) }}</div>
                            </div>
                        </div>

                        <div class="container-fluid">
                            <div class="row">
                              <div class="col-md-12">{{ form_row(form.teaser) }}</div>
                            </div>  
                        </div>

                        <div class="container-fluid">
                            <div class="row">
                              <div class="col-md-12">{{ form_row(form.url) }}</div>
                            </div>  
                        </div>

                        <div id="afficheLieu" onclick="admin.afficheLieu()" class="obligatoire btn-ajout"><p >Date</p></div>

                        <div id="formLieu" class="container-fluid" style="display: none">
                            <div class="row">
                              <div class="col-md-4">{{ form_row(form.deadline) }}</div>
                            </div>
                        </div>

                        <div id="afficheDoc" onclick="admin.afficheDoc()" class="obligatoire btn-ajout"><p>Description / Documents(photos)</p></div>

                        <div id="formDoc" class="container-fluid" style="display: none">
                            <div class="row">
                              <div class="col-md-12">
                                    {{ form_row(form.description) }}

                                    <div id="ajoutDoc"><IMG class="imagePlus" src="{{ asset('bundles/app/images/plus.png') }}" alt="ajout document" /> Cliquer ici pour ajouter des documents</div>

                                    <div class="form-document">
                                        <div class="cadre-upload">{{ form_row(form.documents) }}</div>
                                    </div>


                            </div>
                            </div>
                        </div>
                        <div class="container-fluid">
                            <div class="row">
                                <input type="submit" value="Enregistrez" class="btn btn-primary btn-lg">
                            </div>
                        </div>
                    </form>
                    <script type="text/javascript">

                        $(document).ready(function() {

                            // On récupère la balise <div> en question qui contient l'attribut « data-prototype » qui nous intéresse.
                            var $container = $('div#form_documents');

                            // On ajoute un lien pour ajouter une nouvelle catégorie
                            var $lienAjout = $('<p class="btn btn-warning btn-ajout"><a href="#" id="ajout_document">+ Ajouter un autre document</a></p>');
                            $container.append($lienAjout);

                            // On ajoute un nouveau champ à chaque clic sur le lien d'ajout.
                            $lienAjout.click(function(e) {
                                ajouterDocument($container);
                                e.preventDefault(); // évite qu'un # apparaisse dans l'URL
                                return false;
                            });
                            // La fonction qui ajoute un formulaire Document
                            function ajouterDocument($container) {
                                // Dans le contenu de l'attribut « data-prototype », on remplace :
                                // - le texte "__name__label__" qu'il contient par le label du champ
                                // - le texte "__name__" qu'il contient par le numéro du champ
                                var $prototype = $($container.attr('data-prototype').replace(/__name__label__/g, 'Document n°' + (index+1))
                                        .replace(/__name__/g, index)
                                        .replace('class="required"', 'class="labelDoc"'));

                                // On ajoute au prototype un lien pour pouvoir supprimer la catégorie
                                ajouterLienSuppression($prototype);

                                // On ajoute le prototype modifié à la fin de la balise <div>
                                $container.append($prototype);

                                // Enfin, on incrémente le compteur pour que le prochain ajout se fasse avec un autre numéro
                                index++;
                            }

                            // On définit un compteur unique pour nommer les champs qu'on va ajouter dynamiquement
                            var index = $container.find(':input').length;

                            // On ajoute un premier champ directement s'il n'en existe pas déjà un (cas d'un nouvel article par exemple).
                            if (index == 0) {
                                ajouterDocument($container);
                            } else {
                                // Pour chaque catégorie déjà existante, on ajoute un lien de suppression
                                $container.children('div').each(function() {
                                    ajouterLienSuppression($(this));
                                });
                            }
                        

                            // La fonction qui ajoute un lien de suppression d'une catégorie
                            function ajouterLienSuppression($prototype) {
                                // Création du lien
                                $lienSuppression = $('<p class="btn btn-danger"><a href="#">Supprimer</a></p>');

                                // Ajout du lien
                                $prototype.append($lienSuppression);

                                // Ajout du listener sur le clic du lien
                                $lienSuppression.click(function(e) {
                                    $prototype.remove();
                                    e.preventDefault(); // évite qu'un # apparaisse dans l'URL
                                    return false;
                                });
                            }



                        });
                    </script>
                </div>
            </div>
            <div id="next">
            <h2>Votez pour organiser les contenus</h2>
                <h4>Prochaine Newsletter (envoi prévu le 1er décembre 2016)</h4>
                <p><a href="#">Voir la newsletter précedente</a> </p>


                {% if arrayProposition|length > 0 %}
                    {% for key, item in arrayProposition %}

                        {% set cheminDoc = "" %}
                        {% set break = false %}
                        {% for document in item.getDocuments if not break %}
                            {% set ext = document.getWebDoc|split('.') %}
                            {% if ext[1] == "jpeg" or ext[1] == "png" %}
                                {% set cheminDoc = document.getWebDoc %}
                                {% set break = true %}
                            {% endif %}
                        {% endfor %}

                        <div id="cadre">
                            <div>Position : {{ key + 1 }}</div>
                            <div id="imgPres"><img src="{% if cheminDoc != "" %}{{ asset(cheminDoc) }}{% else %}{{ asset('bundles/app/images/pasimage.png') }}{% endif %}"></div>
                            <div>{{ item.getTitle }}</div>
                            <div>{{ item.getLieu }}</div>
                            <div>{{ item.getTeaser }}</div>
                            <div><a href="{{ item.getUrl }}" target="_blank">Lien</a></div>
                            <div>{{ item.getTheme }}</div>
                            {% if item.getDescription|length > 0 %}
                                {% set idDesc = 'desc' ~ key %}
                                <div id='{{ idDesc }}_sp' onclick='admin.afficheDesc("{{ idDesc }}")'><p >En savoir plus</p></div>
                                <div id="{{ idDesc }}" style="display: none"><p>{{  item.getDescription|raw }}</p></div>
                                <div id='{{ idDesc }}_r' onclick='admin.cacheDesc("{{ idDesc }}")' style="display: none"><p >Réduire</p></div>
                            {% endif %}
                            <div id="imgAction">
                                <a href="{{ path('proposition_monte', {'id': item.getId}) }}" data-toggle="tooltip" title="Faire monter la proposition">
                                    <img src="{{ asset('bundles/app/images/monte.png') }}">
                                </a>
                                <a href="{{ path('proposition_descend', {'id': item.getId}) }}" data-toggle="tooltip" title="Faire desencdre la proposition">
                                    <img src="{{ asset('bundles/app/images/descend.png') }}">
                                </a>
                                <a href="{{ path('proposition_interdit', {'id': item.getId}) }}" data-toggle="tooltip" title="Faire annuler la proposition">
                                    <img src="{{ asset('bundles/app/images/interdit.png') }}">
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}

             </div>
        </div>
    </div>
{% endblock %}
